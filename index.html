<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSCAL Requirements Gap Analysis Tool</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Inter", sans-serif;
            font-optical-sizing: auto;
            font-weight: 500;
            font-style: normal;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 400;
        }

        .controls-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .control-card {
            background: white;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .control-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .control-card.collapsed {
            opacity: 0.8;
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            cursor: pointer;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #e0e6ed;
            transition: background 0.3s ease;
        }

        .control-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }

        .control-header.satisfied {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-bottom-color: #c3e6cb;
        }

        .control-header.satisfied:hover {
            background: linear-gradient(135deg, #c3e6cb 0%, #b8dabd 100%);
        }

        .control-content {
            padding: 20px;
            transition: all 0.3s ease;
        }

        .control-content.collapsed {
            max-height: 0;
            padding: 0 20px;
            overflow: hidden;
        }

        .control-title-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .accordion-icon {
            font-size: 1.2em;
            font-weight: bold;
            color: #667eea;
            transition: transform 0.3s ease;
            user-select: none;
        }

        .accordion-icon.collapsed {
            transform: rotate(-90deg);
        }

        .control-id {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .control-status {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
        }

        .status-indicator.satisfied {
            background: #27ae60;
        }

        .control-description {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #555;
        }

        .control-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #219a52;
        }

        .btn-danger {
            background: #a32315;
            color: white;
            font-weight: 900;
        }

        .btn-danger:hover {
            background: #e44230;
        }

        .btn-secondary {
            background: #39813c;
            color: white;
            font-weight: 900;
        }

        .btn-secondary:hover {
            background: #87ca74;
        }

        .response-area {
            margin-top: 15px;
        }

        .response-area textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .response-area textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .results-table th {
            background: #2c3e50;
            color: white;
            font-weight: 500;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .gap-indicator {
            padding: 6px 12px;
            border-radius: 15px;
            font-weight: bold;
            font-size: 0.85em;
        }

        .gap-yes {
            background: #d4edda;
            color: #155724;
        }

        .gap-no {
            background: #f8d7da;
            color: #721c24;
        }

        .file-input-section {
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .file-input {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .file-input-label:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .risk-matrix {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 20px 0;
            max-width: 600px;
        }

        .risk-cell {
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8em;
        }

        .risk-header {
            background: #2c3e50;
            color: white;
        }

        .risk-low { background: #27ae60; color: white; }
        .risk-medium { background: #f39c12; color: white; }
        .risk-high { background: #e74c3c; color: white; }

        .ofi-section {
            margin-top: 30px;
            padding: 25px;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }

        .ofi-card {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .cia-ratings {
            display: flex;
            gap: 20px;
            margin: 15px 0;
        }

        .cia-rating {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .cia-rating label {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .cia-rating select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .comparison-table th, .comparison-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e6ed;
        }

        .comparison-table th {
            background: #34495e;
            color: white;
            font-weight: 600;
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .comparison-table tr:first-child:hover {
            background: transparent;
        }

        /* Visual Risk Matrix Styles - matching Bow Tie tool */
        .risk-matrix-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 900px;
            margin: 0 auto;
            position: relative;
        }

        .visual-risk-matrix {
            width: 100%;
            border-collapse: collapse;
            margin: 0 auto;
            font-size: 14px;
            background: white;
            position: relative;
        }

        .visual-risk-matrix th, .visual-risk-matrix td {
            border: 2px solid #34495e;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            position: relative;
            min-height: 50px;
        }

        .matrix-corner {
            background: #34495e;
            color: white;
            font-size: 12px;
            width: 120px;
        }

        .matrix-header {
            background: #34495e;
            color: white;
            font-size: 13px;
            padding: 8px 4px;
        }

        .consequence-header {
            background: #34495e;
            color: white;
            font-size: 11px;
            padding: 8px 4px;
            min-width: 80px;
        }

        .likelihood-header {
            background: #34495e;
            color: white;
            font-size: 12px;
            text-align: center;
            writing-mode: horizontal-tb;
            width: 120px;
        }

        .matrix-cell {
            position: relative;
            height: 70px;
            width: 120px;
            font-size: 12px;
            font-weight: 700;
            cursor: default;
            transition: all 0.3s ease;
            vertical-align: middle;
        }

        .matrix-cell.low {
            background: #27ae60;
            color: white;
        }

        .matrix-cell.medium {
            background: #f1c40f;
            color: #2c3e50;
        }

        .matrix-cell.high {
            background: #e67e22;
            color: white;
        }

        .matrix-cell.extreme {
            background: #e74c3c;
            color: white;
        }

        /* Risk position markers - matching Bow Tie style exactly */
        .risk-position {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            z-index: 10;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .risk-position.before {
            background: #2c3e50;
            color: white;
            top: 8px;
            left: 8px;
        }

        .risk-position.after {
            background: #8e44ad;
            color: white;
            top: 8px;
            right: 8px;
        }

        /* OFI Risk Matrix Styles - enhanced to match */
        .ofi-risk-position {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid white;
            z-index: 10;
            font-weight: bold;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .ofi-risk-position:hover {
            transform: scale(1.1);
        }

        .ofi-risk-position.initial {
            /* Dark background for initial risk - positioned like "BEFORE" */
            color: white;
            font-weight: bold;
            top: 8px;
            left: 8px;
        }

        .ofi-risk-position.residual {
            /* Light background for residual risk - positioned like "AFTER" */
            background: white;
            color: #333;
            font-weight: bold;
            border: 3px solid #333;
            top: 8px;
            right: 8px;
        }

        .risk-arrow {
            stroke: #2c3e50;
            stroke-width: 3px;
            stroke-dasharray: 8, 4;
            fill: none;
            marker-end: url(#movement-arrowhead);
            z-index: 15;
        }

        .risk-arrow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15;
        }

        .ofi-movement-arrow {
            stroke-width: 3px;
            stroke-dasharray: 8, 4;
            fill: none;
            marker-end: url(#ofi-movement-arrowhead);
            z-index: 15;
            opacity: 0.8;
            transition: opacity 0.3s ease;
        }

        .ofi-movement-arrow:hover {
            opacity: 1;
            stroke-width: 4px;
        }

        .matrix-legend {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e6ed;
        }

        .matrix-legend h4 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .legend-items {
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #2c3e50;
        }

        .legend-marker {
            font-size: 18px;
            font-weight: bold;
        }

        .before-marker {
            color: #2c3e50;
        }

        .after-marker {
            color: #8e44ad;
        }

        .arrow-marker {
            color: #2c3e50;
        }

        /* Matrix cell highlighting */
        .matrix-cell.current-before {
            box-shadow: inset 0 0 0 4px #2c3e50;
        }

        .matrix-cell.current-after {
            box-shadow: inset 0 0 0 4px #8e44ad;
        }

        .matrix-cell.has-movement {
            animation: riskMovement 2s ease-in-out;
        }

        .matrix-cell.has-ofi-positions {
            position: relative;
        }

        @keyframes riskMovement {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .ofi-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }

        .ofi-toggle:hover {
            background: #e9ecef;
        }

        .ofi-toggle input[type="checkbox"] {
            transform: scale(1.1);
        }

        .ofi-color-indicator {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }

        /* OFI Color Palette */
        .ofi-color-1 { background: #e74c3c; }
        .ofi-color-2 { background: #3498db; }
        .ofi-color-3 { background: #2ecc71; }  
        .ofi-color-4 { background: #f39c12; }
        .ofi-color-5 { background: #9b59b6; }
        .ofi-color-6 { background: #1abc9c; }
        .ofi-color-7 { background: #e67e22; }
        .ofi-color-8 { background: #34495e; }

        .ofi-arrow-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9;
        }

        @media (max-width: 768px) {
            .visual-risk-matrix {
                font-size: 10px;
            }
            
            .matrix-cell {
                height: 50px;
                width: 60px;
                font-size: 10px;
            }
            
            .risk-position, .ofi-risk-position {
                width: 16px;
                height: 16px;
                font-size: 12px;
            }
            
            .legend-items {
                flex-direction: column;
                align-items: center;
                gap: 10px;
            }
            
            .ofi-toggle {
                font-size: 0.8em;
                padding: 6px 10px;
            }
            
            .ofi-color-indicator {
                width: 14px;
                height: 14px;
            }
        }

        .hidden {
            display: none;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        /* Accordion Control Buttons */
        .accordion-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .accordion-controls .btn {
            font-size: 0.9em;
            padding: 8px 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>OSCAL Requirements Gap Analysis Tool</h1>
            <p>Assess compliance gaps against security control requirements</p>
        </div>

        <div class="main-content">
            <!-- File Loading Section -->
            <div class="section">
                <h2>Load Requirements</h2>
                <div class="file-input-section">
                    <div class="file-input">
                        <input type="file" id="oscal-file" accept=".json" />
                        <label for="oscal-file" class="file-input-label">Load OSCAL JSON File</label>
                    </div>
                    <div class="file-input">
                        <input type="file" id="assessment-file" accept=".json" />
                        <label for="assessment-file" class="file-input-label">Resume Assessment</label>
                    </div>
                    <button class="btn btn-primary" onclick="loadDefaultRequirements()">Load PCI DSS 4.0 Sample</button>
                    <button class="btn btn-secondary" onclick="exportResults()">Export Results</button>
                </div>
                <div id="load-status" style="margin-top: 15px; color: #666;"></div>
            </div>

            <!-- Requirements Overview -->
            <div class="section">
                <h2>Requirements Overview</h2>
                <div class="stats-overview" id="stats-overview">
                    <!-- Stats will be populated here -->
                </div>
                <div id="requirements-filter" style="margin-top: 20px;">
                    <label for="family-filter" style="margin-right: 10px;">Filter by Family:</label>
                    <select id="family-filter" onchange="filterRequirements()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Families</option>
                    </select>
                </div>
            </div>

            <!-- Requirements Assessment -->
            <div class="section">
                <h2>Requirements Assessment</h2>
                <div class="accordion-controls">
                    <button class="btn btn-primary" onclick="expandAllRequirements()">Expand All</button>
                    <button class="btn btn-secondary" onclick="collapseAllRequirements()">Collapse All</button>
                    <button class="btn btn-success" onclick="collapseSatisfiedRequirements()">Collapse Satisfied</button>
                </div>
                <div class="controls-grid" id="controls-grid">
                    <!-- Controls will be populated here -->
                </div>
            </div>

            <!-- Results Analysis -->
            <div class="section">
                <h2>Gap Analysis Results</h2>
                <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th>Control ID</th>
                            <th>Title</th>
                            <th>Status</th>
                            <th>Response</th>
                            <th>Gap</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <!-- Results will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- OFI Recommendations -->
            <div class="ofi-section" id="ofi-section">
                <h2>Opportunities for Improvement (OFIs)</h2>
                <div id="ofi-container">
                    <!-- OFIs will be populated here -->
                </div>
                <br/>
                <button class="btn btn-primary" onclick="generateOFIs()">Create OFI recommendations for each gap</button>
            </div>

            <!-- OFI Risk Matrix Visualization -->
            <div class="ofi-section hidden" id="ofi-risk-matrix-section">
                <h2>ðŸ“Š OFI Risk Matrix Visualization</h2>
                <p style="margin-bottom: 20px; color: #666;">Visual representation of how each OFI recommendation affects risk positioning</p>
                
                <!-- Risk Comparison Table -->
                <table class="comparison-table" id="ofi-comparison-table" style="margin-bottom: 30px;">
                    <thead>
                        <tr>
                            <th>OFI</th>
                            <th>Assessment</th>
                            <th>Likelihood</th>
                            <th>Impact</th>
                            <th>Risk Score</th>
                            <th>Risk Level</th>
                        </tr>
                    </thead>
                    <tbody id="ofi-comparison-tbody">
                        <!-- OFI comparison rows will be populated here -->
                    </tbody>
                </table>

                <!-- OFI Toggle Controls -->
                <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px;">Toggle OFI Display:</h4>
                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="toggleAllOFIs(true)" style="font-size: 0.9em; padding: 8px 16px;">Show All</button>
                        <button class="btn btn-secondary" onclick="toggleAllOFIs(false)" style="font-size: 0.9em; padding: 8px 16px;">Hide All</button>
                        <div id="ofi-toggles" style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <!-- Individual OFI toggles will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Risk Matrix -->
                <div class="risk-matrix-container">
                    <table class="visual-risk-matrix" id="ofi-risk-matrix">
                        <thead>
                            <tr>
                                <th rowspan="2" class="matrix-corner">Likelihood Rating</th>
                                <th colspan="5" class="matrix-header">Consequences - Maximum Reasonable Consequence</th>
                            </tr>
                            <tr>
                                <th class="consequence-header">Insignificant</th>
                                <th class="consequence-header">Minor</th>
                                <th class="consequence-header">Moderate</th>
                                <th class="consequence-header">Major</th>
                                <th class="consequence-header">Catastrophic</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th class="likelihood-header">Almost Certain</th>
                                <td class="matrix-cell medium" data-likelihood="5" data-impact="1">Medium</td>
                                <td class="matrix-cell medium" data-likelihood="5" data-impact="2">Medium</td>
                                <td class="matrix-cell high" data-likelihood="5" data-impact="3">High</td>
                                <td class="matrix-cell extreme" data-likelihood="5" data-impact="4">Extreme</td>
                                <td class="matrix-cell extreme" data-likelihood="5" data-impact="5">Extreme</td>
                            </tr>
                            <tr>
                                <th class="likelihood-header">Likely</th>
                                <td class="matrix-cell low" data-likelihood="4" data-impact="1">Low</td>
                                <td class="matrix-cell medium" data-likelihood="4" data-impact="2">Medium</td>
                                <td class="matrix-cell medium" data-likelihood="4" data-impact="3">Medium</td>
                                <td class="matrix-cell high" data-likelihood="4" data-impact="4">High</td>
                                <td class="matrix-cell extreme" data-likelihood="4" data-impact="5">Extreme</td>
                            </tr>
                            <tr>
                                <th class="likelihood-header">Possible</th>
                                <td class="matrix-cell low" data-likelihood="3" data-impact="1">Low</td>
                                <td class="matrix-cell low" data-likelihood="3" data-impact="2">Low</td>
                                <td class="matrix-cell medium" data-likelihood="3" data-impact="3">Medium</td>
                                <td class="matrix-cell high" data-likelihood="3" data-impact="4">High</td>
                                <td class="matrix-cell high" data-likelihood="3" data-impact="5">High</td>
                            </tr>
                            <tr>
                                <th class="likelihood-header">Unlikely</th>
                                <td class="matrix-cell low" data-likelihood="2" data-impact="1">Low</td>
                                <td class="matrix-cell low" data-likelihood="2" data-impact="2">Low</td>
                                <td class="matrix-cell low" data-likelihood="2" data-impact="3">Low</td>
                                <td class="matrix-cell medium" data-likelihood="2" data-impact="4">Medium</td>
                                <td class="matrix-cell high" data-likelihood="2" data-impact="5">High</td>
                            </tr>
                            <tr>
                                <th class="likelihood-header">Rare</th>
                                <td class="matrix-cell low" data-likelihood="1" data-impact="1">Low</td>
                                <td class="matrix-cell low" data-likelihood="1" data-impact="2">Low</td>
                                <td class="matrix-cell low" data-likelihood="1" data-impact="3">Low</td>
                                <td class="matrix-cell low" data-likelihood="1" data-impact="4">Low</td>
                                <td class="matrix-cell medium" data-likelihood="1" data-impact="5">Medium</td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <!-- Legend -->
                    <div class="matrix-legend">
                        <h4>OFI Risk Matrix Legend</h4>
                        <div class="legend-items" id="ofi-matrix-legend">
                            <!-- Legend items will be populated dynamically -->
                        </div>
                        <p style="margin-top: 10px; font-size: 0.9em; color: #666; text-align: center;">
                            Dark circles show initial risk, light circles show residual risk after implementing OFI recommendation
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentRequirements = [];
        let assessmentData = {
            requirements: [],
            responses: {},
            ofis: {}
        };

        // Default PCI DSS data
        const defaultPCIData = {
            "catalog": {
                "securityControls": [
                    {
                        "uuid": "24f3f4e9-b01c-414c-9530-8f022fcbe956",
                        "title": "5.2.1 Anti-malware Solution Deployment",
                        "description": "An anti-malware solution(s) is deployed on all system components, except for those system components identified in periodic evaluations per Requirement 5.2.3 that concludes the system components are not at risk from malware.",
                        "controlId": "5.2.1",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.2.1.a Examine system components to verify that an anti-malware solution(s) is deployed on all system components, except for those determined to not be at risk from malware based on periodic evaluations per Requirement 5.2.3."
                    },
                    {
                        "uuid": "21a340a7-1f9b-40e3-b258-0f54d83c892d",
                        "title": "5.2.2 Anti-malware Capabilities",
                        "description": "The deployed anti-malware solution(s): Detects all known types of malware. Removes, blocks, or contains all known types of malware.",
                        "controlId": "5.2.2",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.2.2 Examine vendor documentation and configurations of the anti-malware solution(s) to verify that the solution detects and removes/blocks/contains all known types of malware."
                    },
                    {
                        "uuid": "c6a73e6a-75ab-4626-97b7-5c5b6de09c3b",
                        "title": "5.2.3 Periodic Evaluations",
                        "description": "Any system components that are not at risk for malware are evaluated periodically to include: A documented list of all system components not at risk for malware. Identification and evaluation of evolving malware threats for those system components. Confirmation whether such system components continue to not require anti-malware protection.",
                        "controlId": "5.2.3",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.2.3.a Examine documented policies and procedures to verify that a process is defined for periodic evaluations of any system components that are not at risk for malware."
                    },
                    {
                        "uuid": "9a58bf0c-8232-40f3-b38c-38b3bcc7904e",
                        "title": "5.2.3.1 Risk-Based Evaluation Frequency",
                        "description": "The frequency of periodic evaluations of system components identified as not at risk for malware is defined in the entity's targeted risk analysis, which is performed according to all elements specified in Requirement 12.3.1.",
                        "controlId": "5.2.3.1",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.2.3.1.a Examine the entity's targeted risk analysis for the frequency of periodic evaluations of system components identified as not at risk for malware."
                    },
                    {
                        "uuid": "df0d85d5-be3d-4ddd-8077-05e308e3f184",
                        "title": "5.3.1 Automatic Updates",
                        "description": "The anti-malware solution(s) is kept current via automatic updates.",
                        "controlId": "5.3.1",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.3.1.a Examine anti-malware solution(s) configurations, including any master installation of the software, to verify the solution is configured to perform automatic updates."
                    },
                    {
                        "uuid": "c1330b77-17ec-46a9-b0b1-eb0e1b0c7584",
                        "title": "5.3.2 Scanning Configuration",
                        "description": "The anti-malware solution(s): Performs periodic scans and active or real-time scans, OR Performs continuous behavioral analysis of systems or processes.",
                        "controlId": "5.3.2",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.3.2.a Examine anti-malware solution(s) configurations to verify the solution(s) is configured to perform at least one of the specified scanning methods."
                    },
                    {
                        "uuid": "f81d9a6d-7f44-444e-af32-82d3ccabf9f7",
                        "title": "5.3.2.1 Scan Frequency",
                        "description": "If periodic malware scans are performed to meet Requirement 5.3.2, the frequency of scans is defined in the entity's targeted risk analysis, which is performed according to all elements specified in Requirement 12.3.1.",
                        "controlId": "5.3.2.1",
                        "family": "Protect All Systems and Networks from Malicious Software",  
                        "assessmentPlan": "5.3.2.1.a Examine the entity's targeted risk analysis for the frequency of periodic malware scans."
                    },
                    {
                        "uuid": "dcbe1aa4-3985-43ef-9833-8edfe4bc70f1",
                        "title": "5.3.3 Removable Media Scanning",
                        "description": "For removable electronic media, the anti-malware solution(s): Performs automatic scans when the media is inserted, connected, or logically mounted, OR Performs continuous behavioral analysis of systems or processes when the media is inserted, connected, or logically mounted.",
                        "controlId": "5.3.3",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.3.3.a Examine anti-malware solution(s) configurations to verify that, for removable electronic media, the solution is configured to perform appropriate scanning."
                    },
                    {
                        "uuid": "9f9416e6-8e3a-4cbb-ad7f-fbf165eeb45d",
                        "title": "5.3.4 Audit Logging",
                        "description": "Audit logs for the anti-malware solution(s) are enabled and retained in accordance with Requirement 10.5.1.",
                        "controlId": "5.3.4",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.3.4 Examine anti-malware solution(s) configurations to verify logs are enabled and retained in accordance with Requirement 10.5.1."
                    },
                    {
                        "uuid": "f93a493f-cbae-4772-addf-bd01e20d9a61",
                        "title": "5.3.5 Protection from Alteration",
                        "description": "Anti-malware mechanisms cannot be disabled or altered by users, unless specifically documented, and authorized by management on a case-by-case basis for a limited time period.",
                        "controlId": "5.3.5",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.3.5.a Examine anti-malware configurations to verify that the anti-malware mechanisms cannot be disabled or altered by users."
                    },
                    {
                        "uuid": "5a73521b-9523-4133-b0f0-0392cb5f115f",
                        "title": "5.4.1 Phishing Protection",
                        "description": "Processes and automated mechanisms are in place to detect and protect personnel against phishing attacks.",
                        "controlId": "5.4.1",
                        "family": "Protect All Systems and Networks from Malicious Software",
                        "assessmentPlan": "5.4.1 Observe implemented processes and examine mechanisms to verify controls are in place to detect and protect personnel against phishing attacks."
                    }
                ]
            }
        };

        // Risk matrix configuration
        const riskMatrix = {
            likelihood: [
                { value: 5, label: "Almost Certain" },
                { value: 4, label: "Likely" },
                { value: 3, label: "Possible" },
                { value: 2, label: "Unlikely" },
                { value: 1, label: "Rare" }
            ],
            impact: [
                { value: 5, label: "Extreme" },
                { value: 4, label: "Major" },
                { value: 3, label: "Moderate" },
                { value: 2, label: "Minor" },
                { value: 1, label: "Insignificant" }
            ]
        };

        // Initialize the application
        function init() {
            setupEventListeners();
            loadDefaultRequirements();
        }

        function setupEventListeners() {
            document.getElementById('oscal-file').addEventListener('change', handleOSCALFileLoad);
            document.getElementById('assessment-file').addEventListener('change', handleAssessmentFileLoad);
        }

        function loadDefaultRequirements() {
            try {
                currentRequirements = defaultPCIData.catalog.securityControls;
                assessmentData.requirements = currentRequirements;
                
                // Initialize responses
                currentRequirements.forEach(req => {
                    if (!assessmentData.responses[req.uuid]) {
                        assessmentData.responses[req.uuid] = {
                            satisfied: false,
                            response: '',
                            gap: true
                        };
                    }
                });

                updateStatsOverview();
                populateFamilyFilter();
                renderRequirements();
                updateResultsTable();
                updateStatus('PCI DSS 4.0 Section 5 requirements loaded successfully');
            } catch (error) {
                updateStatus('Error loading default requirements: ' + error.message, 'error');
            }
        }

        function handleOSCALFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.catalog && data.catalog.securityControls) {
                        currentRequirements = data.catalog.securityControls;
                        assessmentData.requirements = currentRequirements;
                        
                        // Initialize responses
                        currentRequirements.forEach(req => {
                            if (!assessmentData.responses[req.uuid]) {
                                assessmentData.responses[req.uuid] = {
                                    satisfied: false,
                                    response: '',
                                    gap: true
                                };
                            }
                        });

                        updateStatsOverview();
                        populateFamilyFilter();
                        renderRequirements();
                        updateResultsTable();
                        updateStatus(`${currentRequirements.length} requirements loaded successfully`);
                    } else {
                        throw new Error('Invalid OSCAL format');
                    }
                } catch (error) {
                    updateStatus('Error loading OSCAL file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function handleAssessmentFileLoad(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.requirements && data.responses) {
                        assessmentData = data;
                        currentRequirements = data.requirements;
                        
                        updateStatsOverview();
                        populateFamilyFilter();
                        renderRequirements();
                        updateResultsTable();
                        updateStatus('Assessment resumed successfully');
                    } else {
                        throw new Error('Invalid assessment file format');
                    }
                } catch (error) {
                    updateStatus('Error loading assessment file: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('load-status');
            statusDiv.textContent = message;
            statusDiv.style.color = type === 'error' ? '#e74c3c' : '#27ae60';
        }

        function updateStatsOverview() {
            const total = currentRequirements.length;
            const satisfied = Object.values(assessmentData.responses).filter(r => r.satisfied).length;
            const gaps = total - satisfied;
            const coverage = total > 0 ? Math.round((satisfied / total) * 100) : 0;

            const statsHtml = `
                <div class="stat-card">
                    <div class="stat-number">${total}</div>
                    <div class="stat-label">Total Requirements</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${satisfied}</div>
                    <div class="stat-label">Satisfied</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${gaps}</div>
                    <div class="stat-label">Gaps Identified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${coverage}%</div>
                    <div class="stat-label">Coverage</div>
                </div>
            `;
            
            document.getElementById('stats-overview').innerHTML = statsHtml;
        }

        function populateFamilyFilter() {
            const families = [...new Set(currentRequirements.map(req => req.family))];
            const select = document.getElementById('family-filter');
            
            select.innerHTML = '<option value="">All Families</option>';
            families.forEach(family => {
                const option = document.createElement('option');
                option.value = family;
                option.textContent = family;
                select.appendChild(option);
            });
        }

        function filterRequirements() {
            const selectedFamily = document.getElementById('family-filter').value;
            renderRequirements(selectedFamily);
        }

        function renderRequirements(familyFilter = '') {
            const filteredRequirements = familyFilter 
                ? currentRequirements.filter(req => req.family === familyFilter)
                : currentRequirements;

            const gridHtml = filteredRequirements.map(req => {
                const response = assessmentData.responses[req.uuid] || { satisfied: false, response: '', gap: true };
                const statusClass = response.satisfied ? 'satisfied' : '';
                const headerClass = response.satisfied ? 'satisfied' : '';
                const isCollapsed = response.satisfied; // Auto-collapse satisfied requirements
                const contentClass = isCollapsed ? 'collapsed' : '';
                const iconClass = isCollapsed ? 'collapsed' : '';
                const cardClass = isCollapsed ? 'collapsed' : '';
                
                return `
                    <div class="control-card ${cardClass}">
                        <div class="control-header ${headerClass}" onclick="toggleAccordion('${req.uuid}')">
                            <div class="control-title-section">
                                <div class="accordion-icon ${iconClass}" id="icon-${req.uuid}">â–¼</div>
                                <div class="control-id">${req.controlId}</div>
                                <h3 style="margin: 0; color: #2c3e50; font-size: 1.1em;">${req.title}</h3>
                            </div>
                            <div class="control-status">
                                <div class="status-indicator ${statusClass}"></div>
                                <span style="font-weight: 600;">${response.satisfied ? 'Satisfied' : 'Gap'}</span>
                            </div>
                        </div>
                        <div class="control-content ${contentClass}" id="content-${req.uuid}">
                            <div class="control-description" style="margin-bottom: 20px; line-height: 1.6; color: #555; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                                ${req.description}
                            </div>
                            <div class="control-actions" style="margin-bottom: 20px;">
                                <button class="btn ${response.satisfied ? 'btn-success' : 'btn-secondary'}" 
                                        onclick="toggleSatisfaction('${req.uuid}', true)">
                                    Mark Satisfied
                                </button>
                                <button class="btn ${!response.satisfied ? 'btn-danger' : 'btn-secondary'}" 
                                        onclick="toggleSatisfaction('${req.uuid}', false)">
                                    Mark Gap
                                </button>
                            </div>
                            <div class="response-area">
                                <textarea placeholder="Describe how this requirement is satisfied or explain the gap..." 
                                          onchange="updateResponse('${req.uuid}', this.value)"
                                          style="width: 100%; min-height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; resize: vertical; transition: border-color 0.3s ease;">${response.response}</textarea>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('controls-grid').innerHTML = gridHtml;
        }

        function toggleSatisfaction(uuid, satisfied) {
            if (!assessmentData.responses[uuid]) {
                assessmentData.responses[uuid] = { satisfied: false, response: '', gap: true };
            }
            
            assessmentData.responses[uuid].satisfied = satisfied;
            assessmentData.responses[uuid].gap = !satisfied;
            
            updateStatsOverview();
            renderRequirements(document.getElementById('family-filter').value);
            updateResultsTable();
        }

        function updateResponse(uuid, response) {
            if (!assessmentData.responses[uuid]) {
                assessmentData.responses[uuid] = { satisfied: false, response: '', gap: true };
            }
            
            assessmentData.responses[uuid].response = response;
        }

        function toggleAccordion(uuid) {
            const content = document.getElementById(`content-${uuid}`);
            const icon = document.getElementById(`icon-${uuid}`);
            const header = content.parentElement.querySelector('.control-header');
            const card = content.parentElement;
            
            if (content.classList.contains('collapsed')) {
                // Expand
                content.classList.remove('collapsed');
                icon.classList.remove('collapsed');
                card.classList.remove('collapsed');
                content.style.maxHeight = content.scrollHeight + 'px';
                
                // Reset max-height after animation
                setTimeout(() => {
                    if (!content.classList.contains('collapsed')) {
                        content.style.maxHeight = 'none';
                    }
                }, 300);
            } else {
                // Collapse
                content.style.maxHeight = content.scrollHeight + 'px';
                // Force reflow
                content.offsetHeight;
                content.classList.add('collapsed');
                icon.classList.add('collapsed');
                card.classList.add('collapsed');
                content.style.maxHeight = '0px';
            }
        }

        // Accordion Control Functions
        function expandAllRequirements() {
            currentRequirements.forEach(req => {
                const content = document.getElementById(`content-${req.uuid}`);
                const icon = document.getElementById(`icon-${req.uuid}`);
                const card = content?.parentElement;
                
                if (content && content.classList.contains('collapsed')) {
                    content.classList.remove('collapsed');
                    icon?.classList.remove('collapsed');
                    card?.classList.remove('collapsed');
                    content.style.maxHeight = 'none';
                }
            });
        }

        function collapseAllRequirements() {
            currentRequirements.forEach(req => {
                const content = document.getElementById(`content-${req.uuid}`);
                const icon = document.getElementById(`icon-${req.uuid}`);
                const card = content?.parentElement;
                
                if (content && !content.classList.contains('collapsed')) {
                    content.classList.add('collapsed');
                    icon?.classList.add('collapsed');
                    card?.classList.add('collapsed');
                    content.style.maxHeight = '0px';
                }
            });
        }

        function collapseSatisfiedRequirements() {
            currentRequirements.forEach(req => {
                const response = assessmentData.responses[req.uuid];
                if (response && response.satisfied) {
                    const content = document.getElementById(`content-${req.uuid}`);
                    const icon = document.getElementById(`icon-${req.uuid}`);
                    const card = content?.parentElement;
                    
                    if (content && !content.classList.contains('collapsed')) {
                        content.classList.add('collapsed');
                        icon?.classList.add('collapsed');
                        card?.classList.add('collapsed');
                        content.style.maxHeight = '0px';
                    }
                }
            });
        }

        function updateResultsTable() {
            const tbody = document.getElementById('results-tbody');
            
            const rowsHtml = currentRequirements.map(req => {
                const response = assessmentData.responses[req.uuid] || { satisfied: false, response: '', gap: true };
                const gapClass = response.gap ? 'gap-no' : 'gap-yes';
                const gapText = response.gap ? 'Gap' : 'Covered';
                
                return `
                    <tr>
                        <td><strong>${req.controlId}</strong></td>
                        <td>${req.title}</td>
                        <td><span class="gap-indicator ${gapClass}">${gapText}</span></td>
                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis;">${response.response || 'No response provided'}</td>
                        <td>${response.gap ? 'Requires attention' : 'Adequately controlled'}</td>
                    </tr>
                `;
            }).join('');

            tbody.innerHTML = rowsHtml;
        }

        function generateOFIs() {
            const gaps = currentRequirements.filter(req => {
                const response = assessmentData.responses[req.uuid];
                return response && response.gap;
            });

            if (gaps.length === 0) {
                document.getElementById('ofi-container').innerHTML = '<p style="color: #27ae60; font-weight: bold;">No gaps identified - all requirements are satisfied!</p>';
                return;
            }

            const ofisHtml = gaps.map(req => {
                const response = assessmentData.responses[req.uuid];
                const ofi = assessmentData.ofis[req.uuid] || {
                    recommendation: '',
                    initialRisk: { 
                        likelihood: 3, 
                        impact: 3,
                        impactDescription: '',
                        likelihoodDescription: ''
                    },
                    residualRisk: { 
                        likelihood: 2, 
                        impact: 2,
                        impactDescription: '',
                        likelihoodDescription: ''
                    },
                    ciaRatings: { confidentiality: 3, integrity: 3, availability: 3 },
                    assetClass: ''
                };

                const initialRiskScore = calculateRiskScore(ofi.initialRisk.likelihood, ofi.initialRisk.impact);
                const residualRiskScore = calculateRiskScore(ofi.residualRisk.likelihood, ofi.residualRisk.impact);

                return `
                    <div class="ofi-card">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">OFI for ${req.controlId}: ${req.title}</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Gap Description:</strong>
                            <p style="margin: 5px 0; padding: 10px; background: #f8f9fa; border-radius: 4px;">${response.response || 'No specific gap description provided'}</p>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <label><strong>Recommendation:</strong></label>
                            <textarea placeholder="Describe the recommended action to address this gap..." 
                                      style="width: 100%; min-height: 80px; margin-top: 5px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 4px;"
                                      onchange="updateOFI('${req.uuid}', 'recommendation', this.value)">${ofi.recommendation}</textarea>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
                            <div>
                                <h5>Initial Risk (Before Treatment)</h5>
                                <div style="display: flex; gap: 10px; margin: 10px 0;">
                                    <div>
                                        <label>Impact:</label>
                                        <select onchange="updateOFI('${req.uuid}', 'initialRisk.impact', parseInt(this.value)); updateRiskScores('${req.uuid}')">
                                            ${riskMatrix.impact.map(i => 
                                                `<option value="${i.value}" ${ofi.initialRisk.impact === i.value ? 'selected' : ''}>${i.value} - ${i.label}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label>Likelihood:</label>
                                        <select onchange="updateOFI('${req.uuid}', 'initialRisk.likelihood', parseInt(this.value)); updateRiskScores('${req.uuid}')">
                                            ${riskMatrix.likelihood.map(l => 
                                                `<option value="${l.value}" ${ofi.initialRisk.likelihood === l.value ? 'selected' : ''}>${l.value} - ${l.label}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label><strong>Impact Description:</strong></label>
                                    <textarea placeholder="Describe the potential business impact if this risk materializes..." 
                                              style="width: 100%; min-height: 60px; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                              onchange="updateOFI('${req.uuid}', 'initialRisk.impactDescription', this.value)">${ofi.initialRisk.impactDescription || ''}</textarea>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label><strong>Likelihood Description:</strong></label>
                                    <textarea placeholder="Explain why this likelihood rating was selected..." 
                                              style="width: 100%; min-height: 60px; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                              onchange="updateOFI('${req.uuid}', 'initialRisk.likelihoodDescription', this.value)">${ofi.initialRisk.likelihoodDescription || ''}</textarea>
                                </div>
                                <div class="risk-score ${getRiskClass(initialRiskScore)}" id="initial-risk-${req.uuid}" style="padding: 10px; text-align: center; border-radius: 4px; color: white; font-weight: bold;">
                                    Risk Score: ${initialRiskScore} (${getRiskLevel(initialRiskScore)})
                                </div>
                            </div>

                            <div>
                                <h5>Residual Risk (After Treatment)</h5>
                                <div style="display: flex; gap: 10px; margin: 10px 0;">
                                    <div>
                                        <label>Impact:</label>
                                        <select onchange="updateOFI('${req.uuid}', 'residualRisk.impact', parseInt(this.value)); updateRiskScores('${req.uuid}')">
                                            ${riskMatrix.impact.map(i => 
                                                `<option value="${i.value}" ${ofi.residualRisk.impact === i.value ? 'selected' : ''}>${i.value} - ${i.label}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label>Likelihood:</label>
                                        <select onchange="updateOFI('${req.uuid}', 'residualRisk.likelihood', parseInt(this.value)); updateRiskScores('${req.uuid}')">
                                            ${riskMatrix.likelihood.map(l => 
                                                `<option value="${l.value}" ${ofi.residualRisk.likelihood === l.value ? 'selected' : ''}>${l.value} - ${l.label}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label><strong>Residual Impact Description:</strong></label>
                                    <textarea placeholder="Describe the reduced impact after implementing the recommendation..." 
                                              style="width: 100%; min-height: 60px; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                              onchange="updateOFI('${req.uuid}', 'residualRisk.impactDescription', this.value)">${ofi.residualRisk.impactDescription || ''}</textarea>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label><strong>Residual Likelihood Description:</strong></label>
                                    <textarea placeholder="Explain how the recommendation reduces the likelihood..." 
                                              style="width: 100%; min-height: 60px; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;"
                                              onchange="updateOFI('${req.uuid}', 'residualRisk.likelihoodDescription', this.value)">${ofi.residualRisk.likelihoodDescription || ''}</textarea>
                                </div>
                                <div class="risk-score ${getRiskClass(residualRiskScore)}" id="residual-risk-${req.uuid}" style="padding: 10px; text-align: center; border-radius: 4px; color: white; font-weight: bold;">
                                    Risk Score: ${residualRiskScore} (${getRiskLevel(residualRiskScore)})
                                </div>
                            </div>
                        </div>

                        <div style="margin-bottom: 15px;">
                            <h5>CIA Impact Ratings (1-5 scale)</h5>
                            <div class="cia-ratings">
                                <div class="cia-rating">
                                    <label>Confidentiality</label>
                                    <select onchange="updateOFI('${req.uuid}', 'ciaRatings.confidentiality', parseInt(this.value))">
                                        <option value="1" ${ofi.ciaRatings.confidentiality === 1 ? 'selected' : ''}>1 - Very Low</option>
                                        <option value="2" ${ofi.ciaRatings.confidentiality === 2 ? 'selected' : ''}>2 - Low</option>
                                        <option value="3" ${ofi.ciaRatings.confidentiality === 3 ? 'selected' : ''}>3 - Medium</option>
                                        <option value="4" ${ofi.ciaRatings.confidentiality === 4 ? 'selected' : ''}>4 - High</option>
                                        <option value="5" ${ofi.ciaRatings.confidentiality === 5 ? 'selected' : ''}>5 - Very High</option>
                                    </select>
                                </div>
                                <div class="cia-rating">
                                    <label>Integrity</label>
                                    <select onchange="updateOFI('${req.uuid}', 'ciaRatings.integrity', parseInt(this.value))">
                                        <option value="1" ${ofi.ciaRatings.integrity === 1 ? 'selected' : ''}>1 - Very Low</option>
                                        <option value="2" ${ofi.ciaRatings.integrity === 2 ? 'selected' : ''}>2 - Low</option>
                                        <option value="3" ${ofi.ciaRatings.integrity === 3 ? 'selected' : ''}>3 - Medium</option>
                                        <option value="4" ${ofi.ciaRatings.integrity === 4 ? 'selected' : ''}>4 - High</option>
                                        <option value="5" ${ofi.ciaRatings.integrity === 5 ? 'selected' : ''}>5 - Very High</option>
                                    </select>
                                </div>
                                <div class="cia-rating">
                                    <label>Availability</label>
                                    <select onchange="updateOFI('${req.uuid}', 'ciaRatings.availability', parseInt(this.value))">
                                        <option value="1" ${ofi.ciaRatings.availability === 1 ? 'selected' : ''}>1 - Very Low</option>
                                        <option value="2" ${ofi.ciaRatings.availability === 2 ? 'selected' : ''}>2 - Low</option>
                                        <option value="3" ${ofi.ciaRatings.availability === 3 ? 'selected' : ''}>3 - Medium</option>
                                        <option value="4" ${ofi.ciaRatings.availability === 4 ? 'selected' : ''}>4 - High</option>
                                        <option value="5" ${ofi.ciaRatings.availability === 5 ? 'selected' : ''}>5 - Very High</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label><strong>Asset Class/Environment:</strong></label>
                            <input type="text" placeholder="e.g., Critical production systems, Development environment, etc." 
                                   style="width: 100%; margin-top: 5px; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"
                                   value="${ofi.assetClass}" 
                                   onchange="updateOFI('${req.uuid}', 'assetClass', this.value)">
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('ofi-container').innerHTML = ofisHtml;
            
            // Show the OFI Risk Matrix section if there are gaps
            const ofiRiskMatrixSection = document.getElementById('ofi-risk-matrix-section');
            if (ofiRiskMatrixSection) {
                ofiRiskMatrixSection.classList.remove('hidden');
                setupOFIRiskMatrix();
                updateOFIComparisonTable();
            }
        }

        function updateOFIComparisonTable() {
            const gaps = currentRequirements.filter(req => {
                const response = assessmentData.responses[req.uuid];
                return response && response.gap;
            });

            const tbody = document.getElementById('ofi-comparison-tbody');
            if (!tbody || gaps.length === 0) return;

            let tableRows = [];

            gaps.forEach((req, index) => {
                const ofi = assessmentData.ofis[req.uuid];
                if (!ofi || !ofi.initialRisk || !ofi.residualRisk) return;

                const ofiId = index + 1;
                const colorClass = `ofi-color-${((index % 8) + 1)}`;
                const colorStyle = `background: ${getColorFromClass(colorClass)}; width: 16px; height: 16px; border-radius: 50%; display: inline-block; margin-right: 8px;`;

                // Before Controls row
                const initialRiskScore = ofi.initialRisk.likelihood * ofi.initialRisk.impact;
                const initialRiskLevel = getRiskLevel(initialRiskScore);

                tableRows.push(`
                    <tr>
                        <td rowspan="2" style="vertical-align: middle; font-weight: bold;">
                            <div style="display: flex; align-items: center;">
                                <div style="${colorStyle}"></div>
                                OFI-${ofiId}<br>
                                <small style="color: #666; font-weight: normal;">${req.controlId}</small>
                            </div>
                        </td>
                        <td><strong>Before Controls</strong></td>
                        <td>${ofi.initialRisk.likelihood}</td>
                        <td>${ofi.initialRisk.impact}</td>
                        <td>${initialRiskScore}</td>
                        <td><span style="padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; ${getRiskLevelStyle(initialRiskScore)}">${initialRiskLevel}</span></td>
                    </tr>
                `);

                // After Controls row
                const residualRiskScore = ofi.residualRisk.likelihood * ofi.residualRisk.impact;
                const residualRiskLevel = getRiskLevel(residualRiskScore);

                tableRows.push(`
                    <tr>
                        <td><strong>After Controls</strong></td>
                        <td>${ofi.residualRisk.likelihood}</td>
                        <td>${ofi.residualRisk.impact}</td>
                        <td>${residualRiskScore}</td>
                        <td><span style="padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: bold; ${getRiskLevelStyle(residualRiskScore)}">${residualRiskLevel}</span></td>
                    </tr>
                `);
            });

            tbody.innerHTML = tableRows.join('');
        }

        function getRiskLevelStyle(score) {
            if (score >= 20) return 'background: #c0392b; color: white;';  // Very High
            if (score >= 15) return 'background: #e74c3c; color: white;';  // High
            if (score >= 10) return 'background: #f39c12; color: white;';  // Medium
            if (score >= 5) return 'background: #f1c40f; color: #333;';    // Low
            return 'background: #27ae60; color: white;';                   // Very Low
        }

        function updateOFI(uuid, path, value) {
            if (!assessmentData.ofis[uuid]) {
                assessmentData.ofis[uuid] = {
                    recommendation: '',
                    initialRisk: { 
                        likelihood: 3, 
                        impact: 3,
                        impactDescription: '',
                        likelihoodDescription: ''
                    },
                    residualRisk: { 
                        likelihood: 2, 
                        impact: 2,
                        impactDescription: '',
                        likelihoodDescription: ''
                    },
                    ciaRatings: { confidentiality: 3, integrity: 3, availability: 3 },
                    assetClass: ''
                };
            }

            // Handle nested object paths
            const pathParts = path.split('.');
            let obj = assessmentData.ofis[uuid];
            
            for (let i = 0; i < pathParts.length - 1; i++) {
                if (!obj[pathParts[i]]) {
                    obj[pathParts[i]] = {};
                }
                obj = obj[pathParts[i]];
            }
            
            obj[pathParts[pathParts.length - 1]] = value;
        }

        function calculateRiskScore(likelihood, impact) {
            return likelihood * impact;
        }

        function getRiskLevel(score) {
            if (score >= 15) return 'High';
            if (score >= 6) return 'Medium';
            return 'Low';
        }

        function getRiskClass(score) {
            if (score >= 15) return 'risk-high';
            if (score >= 6) return 'risk-medium';
            return 'risk-low';
        }

        function updateRiskScores(uuid) {
            const ofi = assessmentData.ofis[uuid];
            if (!ofi) return;

            // Calculate new risk scores
            const initialRiskScore = calculateRiskScore(ofi.initialRisk.likelihood, ofi.initialRisk.impact);
            const residualRiskScore = calculateRiskScore(ofi.residualRisk.likelihood, ofi.residualRisk.impact);

            // Update initial risk display
            const initialRiskElement = document.getElementById(`initial-risk-${uuid}`);
            if (initialRiskElement) {
                initialRiskElement.className = `risk-score ${getRiskClass(initialRiskScore)}`;
                initialRiskElement.style.cssText = 'padding: 10px; text-align: center; border-radius: 4px; color: white; font-weight: bold;';
                initialRiskElement.textContent = `Risk Score: ${initialRiskScore} (${getRiskLevel(initialRiskScore)})`;
            }

            // Update residual risk display
            const residualRiskElement = document.getElementById(`residual-risk-${uuid}`);
            if (residualRiskElement) {
                residualRiskElement.className = `risk-score ${getRiskClass(residualRiskScore)}`;
                residualRiskElement.style.cssText = 'padding: 10px; text-align: center; border-radius: 4px; color: white; font-weight: bold;';
                residualRiskElement.textContent = `Risk Score: ${residualRiskScore} (${getRiskLevel(residualRiskScore)})`;
            }
        }

        function exportResults() {
            const exportData = {
                timestamp: new Date().toISOString(),
                requirements: currentRequirements,
                responses: assessmentData.responses,
                ofis: assessmentData.ofis,
                summary: {
                    totalRequirements: currentRequirements.length,
                    satisfiedRequirements: Object.values(assessmentData.responses).filter(r => r.satisfied).length,
                    gapsIdentified: Object.values(assessmentData.responses).filter(r => r.gap).length,
                    coveragePercentage: Math.round((Object.values(assessmentData.responses).filter(r => r.satisfied).length / currentRequirements.length) * 100)
                }
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `gap-analysis-results-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            updateStatus('Results exported successfully');
        }

        // OFI Risk Matrix Functions
        function setupOFIRiskMatrix() {
            const gaps = currentRequirements.filter(req => {
                const response = assessmentData.responses[req.uuid];
                return response && response.gap;
            });

            if (gaps.length === 0) return;

            // Initialize OFI data if missing
            gaps.forEach(req => {
                if (!assessmentData.ofis[req.uuid]) {
                    assessmentData.ofis[req.uuid] = {
                        recommendation: '',
                        initialRisk: { likelihood: 3, impact: 3 },
                        residualRisk: { likelihood: 2, impact: 2 },
                        ciaRatings: { confidentiality: 3, integrity: 3, availability: 3 },
                        assetClass: ''
                    };
                }
            });

            // Create toggle controls for each OFI
            createOFIToggles(gaps);
            
            // Create matrix legend
            createOFIMatrixLegend(gaps);
            
            // Initialize matrix with all OFIs visible
            updateOFIRiskMatrix();
        }

        function createOFIToggles(gaps) {
            const toggleContainer = document.getElementById('ofi-toggles');
            if (!toggleContainer) return;

            toggleContainer.innerHTML = '';

            gaps.forEach((req, index) => {
                const ofiId = index + 1;
                const colorClass = `ofi-color-${((index % 8) + 1)}`;
                
                const toggleDiv = document.createElement('div');
                toggleDiv.className = 'ofi-toggle';
                
                toggleDiv.innerHTML = `
                    <div class="ofi-color-indicator ${colorClass}"></div>
                    <input type="checkbox" id="ofi-toggle-${req.uuid}" checked onchange="updateOFIRiskMatrix()">
                    <label for="ofi-toggle-${req.uuid}">OFI-${ofiId}: ${req.controlId}</label>
                `;
                
                toggleContainer.appendChild(toggleDiv);
            });
        }

        function createOFIMatrixLegend(gaps) {
            const legendContainer = document.getElementById('ofi-matrix-legend');
            if (!legendContainer) return;

            const legendItems = [];

            gaps.forEach((req, index) => {
                const ofiId = index + 1;
                const colorClass = `ofi-color-${((index % 8) + 1)}`;
                
                legendItems.push(`
                    <div class="legend-item">
                        <div class="ofi-color-indicator ${colorClass}"></div>
                        <span>OFI-${ofiId}: ${req.controlId}</span>
                    </div>
                `);
            });

            legendContainer.innerHTML = legendItems.join('');
        }

        function updateOFIRiskMatrix() {
            // Clear existing OFI positions and arrows
            clearOFIMatrixElements();

            const gaps = currentRequirements.filter(req => {
                const response = assessmentData.responses[req.uuid];
                return response && response.gap;
            });

            if (gaps.length === 0) return;

            console.log('Updating OFI Risk Matrix for', gaps.length, 'gaps');

            // Add OFI positions for visible OFIs first
            gaps.forEach((req, index) => {
                const toggle = document.getElementById(`ofi-toggle-${req.uuid}`);
                if (!toggle || !toggle.checked) return;

                const ofi = assessmentData.ofis[req.uuid];
                if (!ofi || !ofi.initialRisk || !ofi.residualRisk) {
                    console.log('Missing OFI data for', req.controlId);
                    return;
                }

                const ofiId = index + 1;
                const colorClass = `ofi-color-${((index % 8) + 1)}`;
                
                console.log(`Adding OFI-${ofiId} positions:`, {
                    initial: `L${ofi.initialRisk.likelihood}/I${ofi.initialRisk.impact}`,
                    residual: `L${ofi.residualRisk.likelihood}/I${ofi.residualRisk.impact}`,
                    color: colorClass
                });
                
                addOFIRiskPosition(ofi.initialRisk.likelihood, ofi.initialRisk.impact, ofiId, colorClass, 'initial', req.controlId);
                addOFIRiskPosition(ofi.residualRisk.likelihood, ofi.residualRisk.impact, ofiId, colorClass, 'residual', req.controlId);
            });

            // Create SVG container for arrows after positions are added
            setupOFIArrows();

            // Add movement arrows with delay to ensure positions are rendered
            setTimeout(() => {
                gaps.forEach((req, index) => {
                    const toggle = document.getElementById(`ofi-toggle-${req.uuid}`);
                    if (!toggle || !toggle.checked) return;

                    const ofi = assessmentData.ofis[req.uuid];
                    if (!ofi || !ofi.initialRisk || !ofi.residualRisk) return;

                    const ofiId = index + 1;
                    const colorClass = `ofi-color-${((index % 8) + 1)}`;
                    
                    // Add movement arrow if positions are different
                    if (ofi.initialRisk.likelihood !== ofi.residualRisk.likelihood || 
                        ofi.initialRisk.impact !== ofi.residualRisk.impact) {
                        addOFIMovementArrow(ofi.initialRisk, ofi.residualRisk, colorClass, ofiId, index + 1);
                    }
                });
            }, 200);
        }

        function setupOFIArrows() {
            const matrixContainer = document.querySelector('.risk-matrix-container');
            if (!matrixContainer) return;

            let arrowSvg = document.getElementById('ofi-arrows-svg');
            if (!arrowSvg) {
                arrowSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                arrowSvg.id = 'ofi-arrows-svg';
                arrowSvg.style.position = 'absolute';
                arrowSvg.style.top = '0';
                arrowSvg.style.left = '0';
                arrowSvg.style.width = '100%';
                arrowSvg.style.height = '100%';
                arrowSvg.style.pointerEvents = 'none';
                arrowSvg.style.zIndex = '15';

                // Create arrowhead markers with dynamic colors
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
                
                colors.forEach((color, i) => {
                    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker');
                    marker.setAttribute('id', `ofi-arrowhead-${i + 1}`);
                    marker.setAttribute('markerWidth', '10');
                    marker.setAttribute('markerHeight', '7');
                    marker.setAttribute('refX', '9');
                    marker.setAttribute('refY', '3.5');
                    marker.setAttribute('orient', 'auto');
                    marker.setAttribute('markerUnits', 'strokeWidth');

                    const arrowPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    arrowPath.setAttribute('d', 'M 0 0 L 10 3.5 L 0 7 Z');
                    arrowPath.setAttribute('fill', color);

                    marker.appendChild(arrowPath);
                    defs.appendChild(marker);
                });

                arrowSvg.appendChild(defs);
                matrixContainer.appendChild(arrowSvg);
            }
        }

        function clearOFIMatrixElements() {
            // Remove existing OFI positions
            document.querySelectorAll('.ofi-risk-position').forEach(el => el.remove());
            
            // Clear existing arrows
            const arrowSvg = document.getElementById('ofi-arrows-svg');
            if (arrowSvg) {
                const existingArrows = arrowSvg.querySelectorAll('.ofi-movement-arrow');
                existingArrows.forEach(arrow => arrow.remove());
            }

            // Remove position markers from cells
            document.querySelectorAll('#ofi-risk-matrix .matrix-cell').forEach(cell => {
                cell.classList.remove('has-ofi-positions');
            });
        }

        function addOFIRiskPosition(likelihood, impact, ofiId, colorClass, type, controlId) {
            const cell = document.querySelector(
                `#ofi-risk-matrix .matrix-cell[data-likelihood="${likelihood}"][data-impact="${impact}"]`
            );
            
            if (!cell) {
                console.log(`Cell not found for L${likelihood}/I${impact}`);
                return;
            }

            console.log(`Adding ${type} marker for OFI-${ofiId} in cell L${likelihood}/I${impact}`);

            cell.classList.add('has-ofi-positions');

            const marker = document.createElement('div');
            marker.className = `ofi-risk-position ${type} ofi-${ofiId}`;
            marker.textContent = ofiId;
            marker.title = `OFI-${ofiId} (${controlId}) - ${type === 'initial' ? 'Initial' : 'Residual'} Risk\nLikelihood: ${likelihood}, Impact: ${impact}`;
            
            // Base styles for all markers
            marker.style.position = 'absolute';
            marker.style.width = '22px';
            marker.style.height = '22px';
            marker.style.borderRadius = '50%';
            marker.style.display = 'flex';
            marker.style.alignItems = 'center';
            marker.style.justifyContent = 'center';
            marker.style.fontSize = '11px';
            marker.style.fontWeight = 'bold';
            marker.style.zIndex = '12';
            marker.style.boxShadow = '0 2px 6px rgba(0,0,0,0.4)';
            marker.style.cursor = 'pointer';
            marker.style.transition = 'transform 0.2s ease';

            // Set color and position based on type
            if (type === 'initial') {
                // Initial risk marker - solid color, positioned top-left
                marker.style.background = getColorFromClass(colorClass);
                marker.style.color = 'white';
                marker.style.border = '2px solid white';
                marker.style.top = '4px';
                marker.style.left = '4px';
            } else {
                // Residual risk marker - white background with colored border, positioned top-right
                marker.style.background = 'white';
                marker.style.color = getColorFromClass(colorClass);
                marker.style.border = `2px solid ${getColorFromClass(colorClass)}`;
                marker.style.top = '4px';
                marker.style.right = '4px';
            }

            // Add hover effect
            marker.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.1)';
            });
            marker.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });

            cell.appendChild(marker);
        }

        function addOFIMovementArrow(initialRisk, residualRisk, colorClass, ofiId, colorIndex) {
            const initialCell = document.querySelector(
                `#ofi-risk-matrix .matrix-cell[data-likelihood="${initialRisk.likelihood}"][data-impact="${initialRisk.impact}"]`
            );
            const residualCell = document.querySelector(
                `#ofi-risk-matrix .matrix-cell[data-likelihood="${residualRisk.likelihood}"][data-impact="${residualRisk.impact}"]`
            );

            if (!initialCell || !residualCell || initialCell === residualCell) {
                console.log(`Arrow not created for OFI-${ofiId}: same position or cells not found`);
                return;
            }

            const arrowSvg = document.getElementById('ofi-arrows-svg');
            if (!arrowSvg) {
                console.log('Arrow SVG not found');
                return;
            }

            console.log(`Creating arrow for OFI-${ofiId}`);

            // Get the container for proper coordinate calculation
            const matrixContainer = document.querySelector('.risk-matrix-container');
            const containerRect = matrixContainer.getBoundingClientRect();
            
            // Calculate positions relative to the container
            const initialRect = initialCell.getBoundingClientRect();
            const residualRect = residualCell.getBoundingClientRect();

            // Calculate center points relative to container coordinate system
            const initialX = (initialRect.left + initialRect.width / 2) - containerRect.left;
            const initialY = (initialRect.top + initialRect.height / 2) - containerRect.top;
            const residualX = (residualRect.left + residualRect.width / 2) - containerRect.left;
            const residualY = (residualRect.top + residualRect.height / 2) - containerRect.top;

            // Create the arrow line
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', initialX);
            line.setAttribute('y1', initialY);
            line.setAttribute('x2', residualX);
            line.setAttribute('y2', residualY);
            line.setAttribute('class', 'ofi-movement-arrow');
            line.setAttribute('stroke', getColorFromClass(colorClass));
            line.setAttribute('stroke-width', '3');
            line.setAttribute('stroke-dasharray', '8,4');
            line.setAttribute('marker-end', `url(#ofi-arrowhead-${colorIndex})`);
            line.setAttribute('opacity', '0.8');
            line.setAttribute('data-ofi', ofiId);

            // Add tooltip
            const title = document.createElementNS('http://www.w3.org/2000/svg', 'title');
            title.textContent = `OFI-${ofiId} Risk Movement: ${getRiskLevel(initialRisk.likelihood * initialRisk.impact)} â†’ ${getRiskLevel(residualRisk.likelihood * residualRisk.impact)}`;
            line.appendChild(title);

            arrowSvg.appendChild(line);
            console.log(`Arrow created for OFI-${ofiId} from (${initialX},${initialY}) to (${residualX},${residualY})`);
        }

        function getColorFromClass(colorClass) {
            const colorMap = {
                'ofi-color-1': '#e74c3c',
                'ofi-color-2': '#3498db', 
                'ofi-color-3': '#2ecc71',
                'ofi-color-4': '#f39c12',
                'ofi-color-5': '#9b59b6',
                'ofi-color-6': '#1abc9c',
                'ofi-color-7': '#e67e22',
                'ofi-color-8': '#34495e'
            };
            return colorMap[colorClass] || '#34495e';
        }

        function toggleAllOFIs(show) {
            const checkboxes = document.querySelectorAll('[id^="ofi-toggle-"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = show;
            });
            updateOFIRiskMatrix();
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>